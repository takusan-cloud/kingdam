<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キングダム頂天 数字合わせ</title>
<style>
  body {
    background: url("bg.jpg") no-repeat center center/cover;
    margin: 0;
    color: white;
    font-family: "Arial", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    font-size: 3rem;
    font-weight: bold;
    color: #ff0000;
    text-shadow: 3px 3px 0 #000, 6px 6px 0 #ffd700;
    margin: 10px 0 0 0;
  }
  #controls {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin: 10px 0;
    gap: 5px;
  }
  .btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
  }
  #checkBtn { background: white; color: black; font-weight: bold; }
  #addBtn, #removeBtn { background: #ddd; color: black; }
  #serif {
    font-size: 1.6rem;
    font-weight: bold;
    color: white;
    margin: 5px 0 10px 0;
    text-align: center;
  }
  .container {
    display: flex;
    gap: 20px;
  }
  .busho-block {
    background: rgba(0,0,0,0.6);
    padding: 10px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .busho-name {
    text-align: center;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .power-input {
    width: 90px;
    margin: 2px 0;
    text-align: right;
  }
  .highlight {
    background: yellow;
    border: 2px solid red;
  }
</style>
</head>
<body>
  <h1>キングダム頂天 数字合わせ</h1>

  <div id="controls">
    <button id="checkBtn" class="btn">チェック</button>
    <button id="addBtn" class="btn">＋武将追加</button>
    <button id="removeBtn" class="btn" style="display:none;">−武将削除</button>
    <button id="saveBtn" class="btn" style="background:#555;color:white;">データ保存</button>
  </div>

  <div id="serif">一致なし</div>

  <div class="container" id="bushoContainer"></div>

<script>
let bushoCount = 3;
const maxBusho = 4;
const container = document.getElementById("bushoContainer");
const serifDiv = document.getElementById("serif");
const addBtn = document.getElementById("addBtn");
const removeBtn = document.getElementById("removeBtn");

function createBushoBlock(index) {
  const block = document.createElement("div");
  block.className = "busho-block";
  block.innerHTML = `
    <div class="busho-name">武将${index+1}</div>
    <input class="busho-input busho-name-input" placeholder="名前">
    ${Array(10).fill('').map(() => `<input class="power-input" placeholder="戦力">`).join('')}
  `;
  return block;
}

function renderBushoBlocks() {
  container.innerHTML = "";
  for (let i = 0; i < bushoCount; i++) {
    container.appendChild(createBushoBlock(i));
  }
  loadData(); // ブロック再生成後に復元
}

addBtn.addEventListener("click", () => {
  if (bushoCount < maxBusho) bushoCount++;
  if (bushoCount === maxBusho) { addBtn.style.display = "none"; removeBtn.style.display = "block"; }
  renderBushoBlocks();
});

removeBtn.addEventListener("click", () => {
  if (bushoCount > 3) bushoCount--;
  if (bushoCount < maxBusho) { addBtn.style.display = "block"; removeBtn.style.display = "none"; }
  renderBushoBlocks();
});

// 総当たり計算
function checkCombination() {
  const allInputs = [...document.querySelectorAll('.busho-block')].map(block => {
    const name = block.querySelector('.busho-name-input').value.trim();
    const powers = [...block.querySelectorAll('.power-input')].map(i => parseInt(i.value.replace(/,/g,'')) || 0);
    return { name, powers, block };
  });

  const target = 10000; // ←ここは必要なら表示したい戦力欄から取得
  let found = false;

  // 総当たり（bushoCountに応じて）
  const combinations = getCombinations(allInputs, bushoCount);
  combinations.some(combo => {
    const sum = combo.reduce((acc, b) => acc + (b.powers[0] || 0), 0);
    if (sum === target) {
      combo.forEach(b => b.block.querySelectorAll('.power-input')[0].classList.add('highlight'));
      serifDiv.textContent = getRandomSerif();
      serifDiv.style.color = "red";
      found = true;
      return true;
    }
  });

  if (!found) {
    serifDiv.textContent = "一致なし";
    serifDiv.style.color = "white";
  }
}

function getCombinations(arr, k) {
  const results = [];
  function helper(start, combo) {
    if (combo.length === k) {
      results.push(combo);
      return;
    }
    for (let i = start; i < arr.length; i++) {
      helper(i+1, [...combo, arr[i]]);
    }
  }
  helper(0, []);
  return results;
}

// セリフ3つからランダム
function getRandomSerif() {
  const list = ["おお！やったぞ！","ふぉおおおお！","勝利は目前だ！"];
  return list[Math.floor(Math.random()*list.length)];
}

document.getElementById("checkBtn").addEventListener("click", checkCombination);

// --- ローカルストレージ保存 ---
document.getElementById("saveBtn").addEventListener("click", saveData);

function saveData() {
  const data = [];
  document.querySelectorAll('.busho-block').forEach(block => {
    const name = block.querySelector('.busho-name-input').value;
    const powers = [...block.querySelectorAll('.power-input')].map(i => i.value);
    data.push({ name, powers });
  });
  localStorage.setItem("kingdomData", JSON.stringify({ bushoCount, data }));
}

function loadData() {
  const saved = localStorage.getItem("kingdomData");
  if (!saved) return;
  const parsed = JSON.parse(saved);
  bushoCount = parsed.bushoCount;
  parsed.data.forEach((b, i) => {
    const block = document.querySelectorAll('.busho-block')[i];
    if (!block) return;
    block.querySelector('.busho-name-input').value = b.name;
    block.querySelectorAll('.power-input').forEach((input, idx) => {
      input.value = b.powers[idx] || "";
    });
  });
  if (bushoCount === maxBusho) { addBtn.style.display = "none"; removeBtn.style.display = "block"; }
}

renderBushoBlocks();
</script>
</body>
</html>
