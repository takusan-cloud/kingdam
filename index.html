<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>キングダム頂天 数字合わせ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap');

  :root {
    --card-bg: rgba(0,0,0,0.65);
    --panel-pad: 12px;
  }

  html,body{
    margin:0;
    height:100%;
    font-family:"M PLUS Rounded 1c","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background: url("bg.jpg") no-repeat center top;
    background-size: cover;
    color:#fff;
    -webkit-font-smoothing:antialiased;
  }

  @media (max-width: 880px) {
    html,body {
      background: url("bg.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    h1 { white-space: pre-line; }
  }

  .wrap { max-width:1200px; margin:0 auto; padding:18px; box-sizing:border-box; }

  h1 {
    text-align:center;
    font-size:32px;
    margin:8px 0 14px;
    color:#ff1a1a;
    text-shadow:2px 2px 4px #000;
  }

  .tabs { display:flex; justify-content:center; gap:8px; margin-bottom:12px; }
  .tab-btn { background:#fff; color:#000; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }

  .topbar { display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }

  .panel { background:var(--card-bg); padding:var(--panel-pad); border-radius:8px; box-sizing:border-box; }

  .inputs { display:flex; flex-direction:column; gap:8px; min-width:240px; }
  label { font-weight:700; font-size:14px; color:#fff; display:block; margin-bottom:6px; }

  .text-input, .power-input {
    display:block; width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none;
    background: rgba(255,255,255,0.10); color:#fff; outline:none;
  }
  .text-input::placeholder, .power-input::placeholder { color: rgba(255,255,255,0.6); }

  #targetPower, #placedPower { text-align:right; }

  .controls { display:flex; flex-direction:column; gap:8px; }
  .btn { background:#fff; color:#000; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
  .small { padding:6px 8px; font-size:14px; }

  #members { display:flex; flex-wrap:wrap; gap:18px; margin-top:18px; justify-content:flex-start; }

  .member {
    width:240px; background:var(--card-bg); padding:12px; border-radius:10px; box-sizing:border-box; display:flex; flex-direction:column;
  }
  .member h3 { margin:4px 0 8px; text-align:center; font-size:16px; }
  .member .name { margin-bottom:6px; }
  .member .name input { width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none; background: rgba(255,255,255,0.10); color:#fff; }

  .powers { display:grid; grid-template-columns:1fr 1fr; gap:8px; width:100%; box-sizing:border-box; }
  .powers input { width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none; background: rgba(255,255,255,0.10); color:#fff; text-align:right; }

  .highlight {
    background: rgba(255,255,0,0.35) !important;
    outline: 3px solid rgba(255,0,0,0.9) !important;
    color: #000 !important;
  }

  #result {
    text-align:left;
    margin: 10px 0;
  }
  #result span.serifu {
    display:inline-block;
    background: rgba(255,255,255,0.95);
    color:#c00;
    padding:8px 12px;
    border-radius:12px;
    font-weight:900;
    font-size: 1.2rem;
  }

  #saveMsg { position:fixed; right:14px; top:14px; background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(-8px); transition:opacity .28s, transform .28s; z-index:999; }
  #saveMsg.show { opacity:1; transform:translateY(0); }

  @media (max-width:880px){
    .wrap{ padding:12px; }
    #members{ justify-content:center; }
    .member{ width:92%; }
    .inputs{ min-width:100%; }
    #tabInfo img { width:70%; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>キングダム頂天<br>数字合わせ</h1>

    <div class="tabs">
      <button class="tab-btn" id="tabCalcBtn">計算</button>
      <button class="tab-btn" id="tabInfoBtn">説明</button>
    </div>

    <div id="tabCalc">
      <div class="topbar">
        <div class="panel inputs">
          <label for="targetPower">表示したい戦力</label>
          <input id="targetPower" class="text-input" type="text" placeholder="40,000,000">
          <label for="placedPower">配置済みの戦力</label>
          <input id="placedPower" class="text-input" type="text" placeholder="30,000,000">
        </div>

        <div class="panel controls">
          <button id="checkBtn" class="btn">チェック</button>
          <div style="display:flex; gap:8px;">
            <button id="addBtn" class="btn small">＋武将追加</button>
            <button id="removeBtn" class="btn small">−武将削除</button>
          </div>
          <button id="saveBtn" class="btn">💾 データ保存</button>
        </div>
      </div>

      <div id="result"></div>
      <div id="members" aria-live="polite"></div>
    </div>

    <div id="tabInfo" class="panel" style="display:none; margin-top:12px;">
      <h2 style="margin-top:0;">使い方</h2>
      <ol>
        <li>「表示したい戦力」に目標の戦力を入力します。</li>
        <li>「配置済みの戦力」に数字合わせで使用しない武将を配置した際の戦力を入力します。</li>
        <li>武将1〜3の戦力を入力。「＋武将追加」で武将4〜10も追加可能です。</li>
        <li>「チェック」を押すと、各武将から1つずつ選ぶ総当たりで目標に一致するものを探します。</li>
        <li><strong>一致した場合は澤さんの名言が表示されます！！</strong></li>
      </ol>
      <img src="screenshot1.png" alt="入力例" style="display:block; margin:10px auto;">
    </div>
  </div>

  <div id="saveMsg">✅ 保存しました</div>

<script>
(() => {
  const SAWA_SERIFU = [
    "私の伍は今まで一人も死んでいません",
    "弱者には弱者の戦い方があります",
    "これは卑怯ではなく戦法です",
    "五身一体。私たちは”伍の結束”で生き残りましょう",
    "うおおおおおお！！！"
  ];
  const MAX_MEMBERS = 10;
  let memberCount = 3;

  const membersEl = document.getElementById('members');
  const targetEl = document.getElementById('targetPower');
  const placedEl = document.getElementById('placedPower');
  const checkBtn = document.getElementById('checkBtn');
  const addBtn = document.getElementById('addBtn');
  const removeBtn = document.getElementById('removeBtn');
  const saveBtn = document.getElementById('saveBtn');
  const resultEl = document.getElementById('result');
  const saveMsg = document.getElementById('saveMsg');
  const tabCalcBtn = document.getElementById('tabCalcBtn');
  const tabInfoBtn = document.getElementById('tabInfoBtn');
  const tabCalc = document.getElementById('tabCalc');
  const tabInfo = document.getElementById('tabInfo');

  function toNumber(str){
    if(str === undefined || str === null) return NaN;
    const s = String(str).replace(/,/g,'').replace(/[^\d.-]/g,'');
    if(s === '') return NaN;
    return Number(s);
  }
  function formatWithCommasRaw(str){
    const n = String(str).replace(/[^\d]/g,'');
    if(n==='') return '';
    return Number(n).toLocaleString();
  }

  function setupNumberFieldBehavior(el){
    el.addEventListener('focus', () => {
      el.value = (el.value||'').replace(/,/g,'').replace(/[^\d]/g,'');
    });
    el.addEventListener('blur', () => {
      el.value = formatWithCommasRaw(el.value);
    });
  }

  function makeMemberElement(index, data){
    const wrapper = document.createElement('div');
    wrapper.className = 'member';
    wrapper.dataset.index = index;
    wrapper.innerHTML = `
      <h3>武将${index}</h3>
      <input class="text-input name" placeholder="名前" value="${data && data.name ? escapeHtml(data.name) : ''}">
      <div class="powers">
        ${Array.from({length:10}).map((_,i)=>`<input class="power-input" placeholder="戦力" value="${data && data.powers && data.powers[i] ? escapeHtml(data.powers[i]) : ''}">`).join('')}
      </div>
    `;
    wrapper.querySelectorAll('.power-input').forEach(inp => setupNumberFieldBehavior(inp));
    return wrapper;
  }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

  function captureCurrentData(){
    const members = [];
    Array.from(membersEl.querySelectorAll('.member')).forEach(mdiv=>{
      const name = mdiv.querySelector('.name').value || '';
      const powers = Array.from(mdiv.querySelectorAll('.power-input')).map(p=>p.value || '');
      members.push({ name, powers });
    });
    return {
      memberCount,
      target: targetEl.value || '',
      placed: placedEl.value || '',
      members
    };
  }

  function renderMembers(preserve){
    membersEl.innerHTML = '';
    const saved = (preserve && preserve.members) ? preserve.members : [];
    for(let i=0;i<memberCount;i++){
      const data = saved[i] || { name:'', powers:Array(10).fill('') };
      membersEl.appendChild(makeMemberElement(i+1, data));
    }
    addBtn.disabled = memberCount >= MAX_MEMBERS;
    removeBtn.disabled = memberCount <= 3;
  }

  function saveAll(){
    const data = captureCurrentData();
    localStorage.setItem('kingdom_full_v1', JSON.stringify(data));
    saveMsg.classList.add('show');
    setTimeout(()=>saveMsg.classList.remove('show'), 1200);
  }

  function loadAll(){
    const raw = localStorage.getItem('kingdom_full_v1');
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      if(obj.memberCount) memberCount = obj.memberCount;
      targetEl.value = obj.target || '';
      placedEl.value = obj.placed || '';
      renderMembers(obj);
      [targetEl, placedEl].forEach(el => { el.value = formatWithCommasRaw(el.value); setupNumberFieldBehavior(el); });
    }catch(e){
      console.warn('load failed', e);
      localStorage.removeItem('kingdom_full_v1');
    }
  }

  function checkMatch(){
    document.querySelectorAll('.power-input').forEach(i => i.classList.remove('highlight'));
    const targetNum = toNumber(targetEl.value);
    const placedNum = toNumber(placedEl.value);
    if(isNaN(targetNum)){
      alert('表示したい戦力を入力してください');
      return;
    }
    const needed = targetNum - (isNaN(placedNum) ? 0 : placedNum);

    const memberNodes = Array.from(membersEl.querySelectorAll('.member'));
    const candidates = memberNodes.map((mdiv)=>{
      return Array.from(mdiv.querySelectorAll('.power-input'))
        .map((el, idx) => ({ el, val: toNumber(el.value), idx }))
        .filter(o => !isNaN(o.val));
    });

    for(let i=0;i<candidates.length;i++){
      if(candidates[i].length === 0){
        alert(`武将${i+1}に少なくとも1つは数字（戦力）を入力してください`);
        return;
      }
    }

    let found = null;
    function dfs(memberIndex, sumSoFar, path){
      if(found) return;
      if(sumSoFar > needed) return; // 枝刈り
      if(memberIndex === candidates.length){
        if(sumSoFar === needed){
          found = path.slice();
        }
        return;
      }
      const list = candidates[memberIndex];
      for(let i=0;i<list.length;i++){
        const node = list[i];
        path.push(node);
        dfs(memberIndex+1, sumSoFar + node.val, path);
        path.pop();
        if(found) return;
      }
    }
    dfs(0, 0, []);

    if(found){
      found.forEach(obj => obj.el.classList.add('highlight'));
      const quote = SAWA_SERIFU[Math.floor(Math.random()*SAWA_SERIFU.length)];
      resultEl.innerHTML = `<span class="serifu">${escapeHtml(quote)}</span>`;
    } else {
      resultEl.textContent = '一致なし';
    }
  }

  [targetEl, placedEl].forEach(el => setupNumberFieldBehavior(el));

  addBtn.addEventListener('click', ()=>{
    const cur = captureCurrentData();
    if(memberCount < MAX_MEMBERS){
      memberCount++;
      renderMembers(cur);
    }
  });
  removeBtn.addEventListener('click', ()=>{
    const cur = captureCurrentData();
    if(memberCount > 3){
      memberCount--;
      cur.members = (cur.members || []).slice(0, memberCount);
      renderMembers(cur);
    }
  });

  checkBtn.addEventListener('click', checkMatch);
  saveBtn.addEventListener('click', saveAll);

  tabCalcBtn.addEventListener('click', ()=>{ tabCalc.style.display='block'; tabInfo.style.display='none'; });
  tabInfoBtn.addEventListener('click', ()=>{ tabCalc.style.display='none'; tabInfo.style.display='block'; });

  renderMembers();
  loadAll();
})();
</script>
</body>
</html>
